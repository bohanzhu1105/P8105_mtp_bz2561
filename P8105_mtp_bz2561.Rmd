---
title: "P8105_mtp_bz2561"
author: "Bohan Zhu"
date: "2025-10-18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(patchwork)
```

```{r, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  fig.retina = 2,
  dpi = 320
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


# Import and Tidy Data

```{r}
exostosis_df = 
  read_excel("data/p8105_mtp_data.xlsx", skip = 8, na = c("NA", ".", "")) |> 
  janitor::clean_names() 
  
exostosis_clean = 
  exostosis_df |> 
  mutate(
    sex= case_match(
      sex, 
      0 ~ "female",
      1 ~ "male"
    ),
    age_group = case_match(
      age_group,
      "2" ~ "18_30",
      "3" ~ "31_40",
      "4" ~ "41_50",
      "5" ~ "51_60",
      c("6", "7", "8") ~ "60+"
    ) |> 
      factor(levels = c("18_30", "31_40", "41_50", "51_60", "60+"),
           ordered = TRUE),
    eop_size_mm = if_else(is.na(eop_size_mm), 0, eop_size_mm),
    eop_size = case_match(
    eop_size,
    "0" ~ "0_5",
    "1" ~ "5_10",
    "2" ~ "10_15",
    "3" ~ "15_20",
    "4" ~ "20_25",
    "5" ~ "25+"
    ) |> 
      factor(levels = c("0_5", "5_10", "10_15", "15_20", "20_25","25+"),
           ordered = TRUE),
    eop_visibility_classification = case_match(
      eop_visibility_classification,
      0 ~ "eop size 0",
      1 ~ "0 < eop size  <=5",
      2 ~ "eop size >= 5"
    ) |> 
      factor(levels = c("eop size 0", "0 < eop size  <=5", "eop size >= 5"),
           ordered = TRUE),
    fhp_size_mm = if_else(is.na(fhp_size_mm), 0, fhp_size_mm),
    fhp_category = case_match(
      fhp_category,
      "0" ~ "0_10",
      "1" ~ "10_20",
      "2" ~ "20_30",
      "3" ~ "30_40",
      "4" ~ "40_50",
      "5" ~ "50_60",
      "6" ~ "60_70",
      "7" ~ "70+"
    ) |> 
      factor(levels = c("0_10", "10_20", "20_30", "30_40", "40_50",
                        "50_60","60_70","70+"),
           ordered = TRUE)
  )
```

The dataset was imported from an Excel file and cleaned by skipping unused header rows, standardizing variable names, and converting missing values into proper NAs. Each numeric code from the original report was translated into meaningful labels for clarity. For example, sex was recoded as male and female, and age groups were organized into ordered categories such as 18–30, 31–40, 41–50, 51–60, and 60+.

Missing EOP size and FHP size measurements were replaced with zeros, and both EOP and FHP size classifications were converted into readable, ordered factor levels (e.g., 0–5 mm, 5–10 mm, 10–15 mm, etc.). The variable eop_visibility_classification was also recoded to reflect visibility categories (EOP size 0 mm, 0 < EOP ≤ 5 mm, EOP ≥ 5 mm).

```{r}
exostosis_clean |> 
  summarise(n())

exostosis_clean |> 
  group_by(sex) |> 
  summarise(participants = n()) |> 
  knitr::kable()

exostosis_clean |> 
  group_by(age_group) |> 
  summarise(participants = n()) |> 
  knitr::kable()
```

After cleaning, the resulting dataset contained `r nrow(exostosis_clean)` observations and `r ncol(exostosis_clean)` variables. Among the variables, several are key to the analysis. 

`EOP size` and `EOP visibility classification` are crucial because they describe the prominence and visibility of the external enlarged protuberance — the main anatomical feature studied. `FHP size` and `FHP category` are also important, as they measure forward head posture, which may be linked to EOP development. Finally, `sex` and `age group` provide demographic context to explore biological or behavioral differences across participants.

```{r}
exostosis_clean |> 
  filter(is.na(age_group))

exostosis_df |>
  filter(
    (eop_size_mm >= 0 & eop_size_mm < 5 & eop_size != 0) |
    (eop_size_mm >= 5 & eop_size_mm < 10 & eop_size != 1) |
    (eop_size_mm >= 10 & eop_size_mm < 15 & eop_size != 2) |
    (eop_size_mm >= 15 & eop_size_mm < 20 & eop_size != 3) |
    (eop_size_mm >= 20 & eop_size_mm < 25 & eop_size != 4) |
    (eop_size_mm >= 25 & eop_size != 5)
  ) |>
  select(eop_size_mm, eop_size)|> 
  knitr::kable()

exostosis_clean |> 
  group_by(eop_shape) |> 
  summarise(participants = n()) |> 
  knitr::kable()

exostosis_clean |> 
  filter(is.na(fhp_size_mm))

exostosis_clean |>
  filter(
    (fhp_size_mm >= 0  & fhp_size_mm < 10 & fhp_category != "0_10") |
    (fhp_size_mm >= 10 & fhp_size_mm < 20 & fhp_category != "10_20") |
    (fhp_size_mm >= 20 & fhp_size_mm < 30 & fhp_category != "20_30") |
    (fhp_size_mm >= 30 & fhp_size_mm < 40 & fhp_category != "30_40") |
    (fhp_size_mm >= 40 & fhp_size_mm < 50 & fhp_category != "40_50") |
    (fhp_size_mm >= 50 & fhp_size_mm < 60 & fhp_category != "50_60") |
    (fhp_size_mm >= 60 & fhp_category != "60_70" & fhp_category != "70+")
  ) |>
  select(fhp_size_mm, fhp_category) |> 
  knitr::kable()


exostosis_df |>
  mutate(fhp_category = as.numeric(fhp_category)) |>
  filter(fhp_category > 7) |> 
  select(fhp_category)
```

The dataset shows several issues where categorical variables do not fully match their underlying continuous measures. For instance, `age_group` has two missing entries, one participants aged 0–17, a range that was not included in the defined classification range, while another who aged 45 is miss-classified into group 1.

A few classification errors among `eop_size_mm` and `fhp_size_mm` were corrected, mainly caused by inconsistencies in whether boundaries were treated as inclusive or exclusive.

Besides, `eop_shape` includes categories 1, 2, 3, and 5, but category 4 is missing, while over 500 observations are recorded as NA, suggesting incomplete or inconsistent coding. 

In `fhp_category`, one record has a value of 30.8, which by definition should fall within the 30–40 range but was not properly categorized. Additionally, six missing values were identified in `fhp_size_mm`, meaning that a few participants lack corresponding FHP measurements. 

# Visualization

```{r}
Figure_3_advanced = 
  exostosis_clean |>
  filter(!is.na(age_group), !is.na(fhp_size_mm)) |>
  ggplot(aes(x = age_group, y = fhp_size_mm, fill = sex)) +
  geom_violin(width = 0.7, alpha = 0.5) +
  geom_boxplot(width = 0.2, position = position_dodge(width = 0.7)) +
  labs(
    title = "Distribution of FHP by Age Group and Sex",
    x = "Age Group (years)",
    y = "FHP Size (mm)",
    fill = "Sex"
  ) +
  theme(legend.position = "right",
        axis.title.y = element_text(size = 8),
    plot.caption = element_text(size = 5, hjust = 0.5)
  )
```

```{r}
Figure_4_advanced =
  exostosis_clean |>
  mutate(
    enlarged = 
      if_else(eop_size %in% c("10_15", "15_20", "20_25", "25+"), 1, 0)
  ) |>
  filter(!is.na(age_group), !is.na(sex)) |>    
  group_by(age_group, sex) |>
  summarise(
    total = n(),
    enlarged_n = sum(enlarged, na.rm = TRUE),
    rate = enlarged_n / total * 100
  ) |>
  ggplot(aes(x = age_group, y = rate, color = sex, group = sex)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(
    title = "Rate of Enlarged EOP by Age Group and Sex",
    x = "Age Group (years)",
    y = "Rate of Enlarged EOP",
    color = "Sex"
  ) +
  theme(legend.position = "right",
        axis.title.y = element_text(size = 8),
    plot.caption = element_text(size = 5, hjust = 0.5)
)
```

```{r}
combined_plot = 
  (Figure_3_advanced / Figure_4_advanced) +
   plot_annotation(
    caption = "Combined visualization of FHP and EOP patterns across age and sex groups."
  )
combined_plot
```

Across age groups, males exhibit both greater forward head protraction and a higher prevalence of enlarged EOP, suggesting a stronger morphological adaptation potentially linked to prolonged mechanical loading. The mid-age decline and later increase in both metrics may indicate age-related variation in postural stress or bone remodeling responses.

```{r}
exostosis_clean |>
  filter(!is.na(age_group)) |>
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm, color = sex)) +
  geom_point(alpha = 0.7, size = 1.5) +
  facet_grid(sex ~ age_group) +
  scale_color_manual(values = c("female" = "navy", "male" = "green")) +
  labs(
    title = "Association between FHP Size and EOP Size across Age and Sex",
    x = "Forward Head Protraction Size (mm)",
    y = "EOP Size (mm)",
    color = "Sex"
  ) +
  theme_bw(base_size = 11) +
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```

This plot shows how FHP size relates to EOP size across age and sex groups.
The relationship appears weak in both sexes, with scattered data and no clear trend within age categories. Males exhibit greater variability and generally larger EOP sizes, consistent with prior findings. Overall, EOP enlargement seems more influenced by sex than by FHP size.

# Reproducing reported results and discussion
From the tables appear in first part, small discrepancies exist between the authors’ stated sample sizes and the available data. Overall, there are 21 more participants than reported, and differences appear across all age groups except 51–60.

```{r}
exostosis_clean |>
  group_by(sex) |>
  summarise(
    mean_FHP = round(mean(fhp_size_mm, na.rm = TRUE), 2),
    sd_FHP = round(sd(fhp_size_mm, na.rm = TRUE), 2),
  ) 
```
Author's state that mean FHP in the male cases was 28±15 mm, while that for the female cases was 24±11mm. Results based on sample shows that for male cases is $23.65 \pm 10.69$ and female cases is $28.32 \pm 14.80$ which basically the same as author's result.

```{r}
exostosis_clean |>
  summarise(
    EEOP_prevalence = (sum(eop_size_mm > 10, na.rm = TRUE) /
                       sum(!is.na(eop_size_mm))) * 100
  )
```
EEOP defined as an EOP exceeding 10 mm in size. Results based on sample equals $32.1 \% \approx 33\%$ (According to the author).

```{r}
exostosis_clean |>
  drop_na(age_group) |>
  group_by(age_group) |>
  summarise(
    FHP_over_40_percent = (sum(fhp_size_mm > 40) / n()) * 100
  )
```
For participants over 60, $32.5\%$ (close to $34.5\%$) had FHP > 40 mm, the highest rate among all groups. Thus, both the overall trend and specific values are consistent with the authors’ report
